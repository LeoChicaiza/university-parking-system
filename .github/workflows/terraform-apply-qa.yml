name: 'Terraform Apply - QA Environment'

on:
  push:
    branches: [ "QA", "main" ]
    paths:
      - 'infrastructure/terraform/**'
  workflow_dispatch:
    inputs:
      account_id:
        description: 'AWS Account ID (optional)'
        required: false
        default: ''
      environment:
        description: 'Environment name'
        required: false
        default: 'qa'

jobs:
  terraform-apply:
    name: 'Terraform Apply - QA'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infrastructure/terraform
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: '1.6.0'
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1
    
    - name: Verify AWS Account
      id: verify-aws
      run: |
        echo "=== Verifying AWS Credentials ==="
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        echo "AWS Account ID: $ACCOUNT_ID"
        echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
        
        # Update qa.tfvars with current account ID
        if [ -f "qa.tfvars" ]; then
          sed -i "s/account_id *= *\".*\"/account_id = \"$ACCOUNT_ID\"/g" qa.tfvars
          echo "âœ… Updated qa.tfvars with account ID: $ACCOUNT_ID"
        fi
    
    - name: Terraform Init
      id: init
      run: terraform init
      
    - name: Create Dynamic Key Pair for QA
      id: create-key
      run: |
        echo "=== Creating SSH Key Pair ==="
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        KEY_NAME="parking-qa-key-$TIMESTAMP"
        
        echo "Creating key pair: $KEY_NAME"
        aws ec2 create-key-pair \
          --key-name "$KEY_NAME" \
          --query 'KeyMaterial' \
          --output text > "$KEY_NAME.pem"
        
        chmod 400 "$KEY_NAME.pem"
        echo "KEY_NAME=$KEY_NAME" >> $GITHUB_ENV
        echo "key_name=$KEY_NAME" >> $GITHUB_OUTPUT
        echo "âœ… Key pair created: $KEY_NAME"
        echo "ğŸ“„ Key file: $KEY_NAME.pem (saved for debugging)"
    
    - name: Update QA Variables with Dynamic Key
      id: update-vars
      run: |
        echo "=== Updating QA Configuration ==="
        
        # Create a backup of original
        cp qa.tfvars qa.tfvars.backup
        
        # Create dynamic version
        cp qa.tfvars qa-dynamic.tfvars
        
        # Update key_name
        sed -i "s/key_name *= *\".*\"/key_name = \"$KEY_NAME\"/g" qa-dynamic.tfvars
        
        # Update account_id if from verification step
        if [ -n "${{ steps.verify-aws.outputs.account_id }}" ]; then
          sed -i "s/account_id *= *\".*\"/account_id = \"${{ steps.verify-aws.outputs.account_id }}\"/g" qa-dynamic.tfvars
        fi
        
        echo "âœ… Configuration updated:"
        echo "=== Final QA Configuration ==="
        grep -E "(key_name|environment|account_id|aws_region)" qa-dynamic.tfvars
      
    - name: Terraform Apply for QA
      id: apply
      run: |
        echo "=== Applying Terraform Configuration ==="
        echo "Using variables file: qa-dynamic.tfvars"
        echo "Key pair: $KEY_NAME"
        
        terraform apply -auto-approve -var-file="qa-dynamic.tfvars"
        
        echo "âœ… Terraform apply completed successfully!"
      
    - name: Save Terraform Outputs
      id: outputs
      run: |
        echo "=== Saving Terraform Outputs ==="
        terraform output -json > terraform-outputs.json
        echo "ğŸ“Š Outputs saved to terraform-outputs.json"
        
        # Also save human readable version
        terraform output > terraform-outputs.txt
        cat terraform-outputs.txt
      
    - name: Upload Outputs as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-outputs-qa-${{ github.run_id }}
        path: |
          infrastructure/terraform/terraform-outputs.json
          infrastructure/terraform/terraform-outputs.txt
          infrastructure/terraform/qa-dynamic.tfvars
        retention-days: 7
        
    - name: Display Deployment Summary
      run: |
        echo "=========================================="
        echo "ğŸš€ TERRAFORM DEPLOYMENT SUCCESSFUL! ğŸš€"
        echo "=========================================="
        echo ""
        echo "ğŸ“¡ LOAD BALANCER:"
        terraform output alb_dns
        echo ""
        echo "ğŸ–¥ï¸  BASTION HOST:"
        terraform output bastion_ip
        echo ""
        echo "ğŸ”‘ SSH KEY PAIR: $KEY_NAME"
        echo ""
        echo "ğŸŒ AWS ACCOUNT: ${{ steps.verify-aws.outputs.account_id }}"
        echo ""
        echo "âœ… INFRASTRUCTURE READY FOR MICROSERVICES"
        echo "=========================================="
      
    - name: Save Key Pair as Artifact (Debug)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ssh-key-pair-qa-${{ github.run_id }}
        path: infrastructure/terraform/*.pem
        retention-days: 1