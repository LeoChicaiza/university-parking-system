name: 'Terraform Plan - QA Environment'

on:
  pull_request:
    branches: [ "QA" ]
    paths:
      - 'infrastructure/terraform/**'
      - '.github/workflows/terraform-plan-qa.yml'
  push:
    branches: [ "QA" ]
    paths:
      - 'infrastructure/terraform/**'
      - '.github/workflows/terraform-plan-qa.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  terraform-plan:
    name: 'Terraform Plan - QA'
    runs-on: ubuntu-latest
    
    # Solo ejecutar si es push directo o PR desde el mismo repositorio
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
    
    defaults:
      run:
        working-directory: ./infrastructure/terraform
        shell: bash
    
    steps:
    # ========== PASO 1: CHECKOUT ==========
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha || github.sha }}
    
    # ========== PASO 2: CONFIGURAR TERRAFORM ==========
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: '1.6.0'
        terraform_wrapper: false
    
    # ========== PASO 3: CONFIGURAR AWS ==========
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    # ========== PASO 4: VERIFICAR ARCHIVOS ==========
    - name: Verify Required Files
      run: |
        echo "=== Verificando archivos necesarios ==="
        
        # Verificar que qa.tfvars existe
        if [ ! -f "qa.tfvars" ]; then
          echo "âŒ ERROR: Archivo qa.tfvars no encontrado!"
          echo "Archivos en el directorio:"
          ls -la
          exit 1
        fi
        
        echo "âœ… qa.tfvars encontrado"
        echo ""
        echo "ğŸ“‹ Variables en qa.tfvars:"
        grep -v "^#" qa.tfvars | grep -v "^$" | head -10 || echo "No hay variables visibles"
        
        # Verificar que hay archivos .tf
        TF_FILES_COUNT=$(find . -name "*.tf" -type f | wc -l)
        if [ "$TF_FILES_COUNT" -eq 0 ]; then
          echo "âŒ ERROR: No se encontraron archivos .tf"
          exit 1
        fi
        
        echo "âœ… Encontrados $TF_FILES_COUNT archivos .tf"
    
    # ========== PASO 5: INICIALIZAR TERRAFORM ==========
    - name: Terraform Init
      id: init
      run: |
        echo "=== Inicializando Terraform ==="
        
        terraform init -input=false
        
        if [ $? -eq 0 ]; then
          echo "init_status=success" >> $GITHUB_OUTPUT
          echo "âœ… Terraform init exitoso"
        else
          echo "init_status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Terraform init fallÃ³"
          exit 1
        fi
        
        echo ""
        echo "ğŸ“Š Terraform version:"
        terraform version
        echo ""
        echo "ğŸ“ Workspace:"
        terraform workspace show
    
    # ========== PASO 6: VERIFICAR FORMATO ==========
    - name: Terraform Format Check
      id: fmt
      run: |
        echo "=== Verificando formato ==="
        
        terraform fmt -check -recursive
        
        if [ $? -eq 0 ]; then
          echo "âœ… Todo el cÃ³digo estÃ¡ correctamente formateado"
          echo "fmt_status=success" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸  Algunos archivos necesitan formateo"
          echo "Ejecuta: terraform fmt -recursive"
          echo "fmt_status=needs_formatting" >> $GITHUB_OUTPUT
        fi
    
    # ========== PASO 7: VALIDAR SINTÃXIS ==========
    - name: Terraform Validate
      id: validate
      run: |
        echo "=== Validando configuraciÃ³n ==="
        
        terraform validate
        
        if [ $? -eq 0 ]; then
          echo "validate_status=success" >> $GITHUB_OUTPUT
          echo "âœ… ValidaciÃ³n exitosa"
        else
          echo "validate_status=failed" >> $GITHUB_OUTPUT
          echo "âŒ ValidaciÃ³n fallÃ³"
          exit 1
        fi
    
    # ========== PASO 8: GENERAR PLAN ==========
    - name: Terraform Plan for QA
      id: plan
      run: |
        echo "=== Generando Plan de Terraform ==="
        echo "Usando: qa.tfvars"
        echo ""
        
        terraform plan \
          -var-file="qa.tfvars" \
          -input=false \
          -out=tfplan.binary \
          -detailed-exitcode
        
        PLAN_EXIT_CODE=$?
        echo "plan_exit_code=$PLAN_EXIT_CODE" >> $GITHUB_OUTPUT
        
        if [ $PLAN_EXIT_CODE -eq 0 ]; then
          echo "âœ… No se requieren cambios"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "plan_ready=false" >> $GITHUB_OUTPUT
        elif [ $PLAN_EXIT_CODE -eq 2 ]; then
          echo "âœ… Cambios detectados"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "plan_ready=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ Error generando plan"
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "plan_ready=false" >> $GITHUB_OUTPUT
          exit 1
        fi
    
    # ========== PASO 9: PROCESAR SALIDA DEL PLAN ==========
    - name: Process Plan Output
      if: steps.plan.outputs.plan_ready == 'true'
      run: |
        echo "=== Procesando salida del plan ==="
        
        # Convertir a JSON
        terraform show -json tfplan.binary > tfplan.json
        
        # Convertir a texto
        terraform show tfplan.binary > tfplan.txt
        
        # Crear resumen simple
        echo "# Resumen del Plan - QA" > plan-summary.md
        echo "" >> plan-summary.md
        echo "**Run ID:** ${{ github.run_id }}" >> plan-summary.md
        echo "**Rama:** ${{ github.ref_name }}" >> plan-summary.md
        echo "" >> plan-summary.md
        echo "## Cambios propuestos:" >> plan-summary.md
        echo "\`\`\`" >> plan-summary.md
        terraform show tfplan.binary | grep -E "(Plan:|to add|to change|to destroy)" >> plan-summary.md
        echo "\`\`\`" >> plan-summary.md
        
        # Mostrar en logs
        echo ""
        echo "ğŸ“‹ RESUMEN:"
        terraform show tfplan.binary | grep -E "(Plan:|to add|to change|to destroy)"
    
    # ========== PASO 10: SUBIR ARTIFACTS ==========
    - name: Upload Plan Artifact
      if: steps.plan.outputs.plan_ready == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-qa-${{ github.run_id }}
        path: |
          infrastructure/terraform/tfplan.binary
          infrastructure/terraform/tfplan.json
          infrastructure/terraform/tfplan.txt
          infrastructure/terraform/plan-summary.md
        retention-days: 7
    
    # ========== PASO 11: COMENTAR EN PR (VERSIÃ“N SIMPLE Y SEGURA) ==========
    - name: Comment Plan on PR
      if: github.event_name == 'pull_request' && steps.plan.outputs.plan_ready == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          console.log('=== Agregando comentario al PR ===');
          
          try {
            // InformaciÃ³n bÃ¡sica
            const runId = context.runId;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            const prNumber = context.issue.number;
            const serverUrl = context.serverUrl;
            
            // Construir URLs
            const actionsUrl = serverUrl + '/' + repoOwner + '/' + repoName + '/actions/runs/' + runId;
            const workflowUrl = serverUrl + '/' + repoOwner + '/' + repoName + '/actions/workflows/terraform-apply-qa.yml';
            
            // Crear comentario CON concatenaciÃ³n simple (evita problemas de YAML)
            const commentBody = 
              '## ğŸš€ Terraform Plan - QA Environment\n\n' +
              'âœ… Plan generado exitosamente!\n\n' +
              '### ğŸ“Š InformaciÃ³n del plan:\n\n' +
              'â€¢ **Run ID:** `' + runId + '`\n' +
              'â€¢ **Estado:** Cambios detectados âœ…\n\n' +
              '### ğŸ”— Pasos para aplicar:\n\n' +
              '1. **Revisa** el plan en [GitHub Actions #' + runId + '](' + actionsUrl + ')\n' +
              '2. **Aprueba** este PR si los cambios son correctos\n' +
              '3. **Haz merge** a la rama QA\n' +
              '4. **Ejecuta** manualmente [Terraform Apply - QA](' + workflowUrl + ')\n' +
              '5. **Usa el Run ID:** `' + runId + '`\n\n' +
              'ğŸ“¦ **Archivos disponibles en artifacts** (7 dÃ­as)\n' +
              'ğŸ†” **Run ID para copiar:** `' + runId + '`';
            
            // Publicar comentario
            const response = await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: repoOwner,
              repo: repoName,
              body: commentBody
            });
            
            console.log('âœ… Comentario agregado al PR');
            console.log('ğŸ”— URL:', response.data.html_url);
            
          } catch (error) {
            console.error('âŒ Error agregando comentario:', error.message);
            
            // Comentario mÃ­nimo de respaldo
            try {
              const simpleComment = 
                '## Terraform Plan - QA\n\n' +
                'Plan generado. Run ID: `' + context.runId + '`\n\n' +
                'Usa este ID en Terraform Apply workflow.';
                
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: simpleComment
              });
              
              console.log('âœ… Comentario simple agregado');
            } catch (simpleError) {
              console.error('âŒ Error con comentario simple:', simpleError.message);
            }
          }
    
    # ========== PASO 12: RESUMEN FINAL ==========
    - name: Plan Summary
      if: always()
      run: |
        echo ""
        echo "========================================"
        echo "ğŸ“‹ RESUMEN - TERRAFORM PLAN QA"
        echo "========================================"
        echo ""
        echo "ğŸ“Š Estado: ${{ job.status }}"
        echo "ğŸ†” Run ID: ${{ github.run_id }}"
        echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
        echo "ğŸ¯ Evento: ${{ github.event_name }}"
        echo ""
        
        if [ "${{ steps.plan.outputs.plan_ready }}" = "true" ]; then
          echo "âœ… PLAN GENERADO EXITOSAMENTE"
          echo ""
          echo "ğŸ“¦ Artifact: terraform-plan-qa-${{ github.run_id }}"
          echo "â³ VÃ¡lido por: 7 dÃ­as"
          echo ""
          echo "ğŸš€ PRÃ“XIMOS PASOS:"
          echo "   1. Revisa el plan en artifacts/comentario del PR"
          echo "   2. Si estÃ¡ correcto, aprueba el PR"
          echo "   3. Ejecuta 'Terraform Apply - QA' con Run ID:"
          echo ""
          echo "      ${{ github.run_id }}"
          
        elif [ "${{ steps.plan.outputs.has_changes }}" = "false" ]; then
          echo "âœ… SIN CAMBIOS NECESARIOS"
          echo ""
          echo "ğŸ“Š Resultado: Infraestructura actualizada"
          echo "ğŸ’¡ No se requieren modificaciones"
          
        else
          echo "âš ï¸ PLAN NO GENERADO"
          echo ""
          echo "ğŸ” Revisa los logs anteriores para ver errores"
          echo ""
          echo "ğŸ“ Estados:"
          echo "   â€¢ init: ${{ steps.init.outcome }}"
          echo "   â€¢ validate: ${{ steps.validate.outcome }}"
          echo "   â€¢ plan: ${{ steps.plan.outcome }}"
        fi
        
        echo ""
        echo "========================================"