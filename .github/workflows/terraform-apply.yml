name: 'Terraform Apply - QA Environment'

on:
  push:
    branches: [ QA ]
    paths:
      - 'infrastructure/terraform/**'

jobs:
  terraform-apply:
    name: 'Terraform Apply - QA'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./infrastructure/terraform
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: '1.6.0'
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: us-east-1
    
    - name: Terraform Init
      run: terraform init
      
    - name: Create Dynamic Key Pair for QA
      id: create-key
      run: |
        # Crear nombre único para key pair
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        KEY_NAME="parking-qa-key-$TIMESTAMP"
        
        # Crear key pair en AWS
        aws ec2 create-key-pair \
          --key-name "$KEY_NAME" \
          --query 'KeyMaterial' \
          --output text > "$KEY_NAME.pem"
        
        # Establecer permisos correctos (en Linux)
        chmod 400 "$KEY_NAME.pem"
        
        # Guardar key name para uso posterior
        echo "KEY_NAME=$KEY_NAME" >> $GITHUB_ENV
        echo "key_name=$KEY_NAME" >> $GITHUB_OUTPUT
        
        # Opcional: subir el .pem como artifact (solo para debugging)
        # echo "PEM_FILE=$KEY_NAME.pem" >> $GITHUB_ENV
    
    - name: Update QA Variables with Dynamic Key
      run: |
        # Crear versión temporal de qa.tfvars con key dinámica
        cp qa.tfvars qa-dynamic.tfvars
        
        # Actualizar key_name en el archivo temporal
        sed -i "s/key_name *= *\".*\"/key_name = \"$KEY_NAME\"/g" qa-dynamic.tfvars
        
        # Mostrar cambios
        echo "=== QA Configuration ==="
        grep -E "(key_name|environment|account_id)" qa-dynamic.tfvars
      
    - name: Terraform Apply for QA
      run: |
        terraform apply -auto-approve -var-file="qa-dynamic.tfvars"
      
    - name: Save Terraform Outputs
      run: terraform output -json > terraform-outputs.json
      
    - name: Upload Outputs as Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-outputs-qa
        path: infrastructure/terraform/terraform-outputs.json
        
    - name: Display Outputs
      run: |
        echo "=== TERRAFORM OUTPUTS ==="
        terraform output
        echo ""
        echo "=== ALB DNS ==="
        terraform output alb_dns
        echo ""
        echo "=== Bastion IP ==="
        terraform output bastion_ip